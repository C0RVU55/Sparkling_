<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bbuy">
	
	
	 <resultMap type="map" id="scoreMap">
        <result column="sumscore" property="sumScore"/>
        <result column="sumwin" property="sumWin"/>
    </resultMap>
    
	<insert id="insertBBuy" parameterType="BBuyVo">
	 <![CDATA[
			insert into bbuy
			values( seq_bbuy_no.nextval,
			        #{user_no},
			        #{booking_no},
			        #{profile_no},
			        #{b_buy_paytype},
			        #{price},
			        #{b_buy_state},
			        #{b_buy_player_state},
			        null,
			        null,
			        null,
			        null,
			        sysdate)	 	
	 
	 ]]>
	</insert>
	
	<insert id="insertBBuy2" parameterType="BBuyVo">
	
			<selectKey keyProperty="b_buy_no" resultType="int" order="BEFORE">
				select seq_bbuy_no.nextval
				from dual
			</selectKey>

	
	<![CDATA[
		insert into bbuy
		values( #{b_buy_no},
		        #{user_no},
	]]>
		<choose>
		        <when test="booking_no != null and booking_no != 0 ">
					${booking_no},
				</when>
				<otherwise>
		        		null,
				</otherwise>
		</choose>
		        #{profile_no},
		        null,
		        null,
		        null,
		        <choose>
		        	<when test="b_buy_player_state != null and b_buy_player_state != '' ">
		        	#{b_buy_player_state},
					
					</when>
					<otherwise>
		        		null,
				</otherwise>
				</choose>
				 <choose>
		        	<when test="b_buy_address != null and b_buy_address != '' ">
		        	
		       			 #{b_buy_address},
					
					</when>
					<otherwise>
		        		null,
				</otherwise>
				</choose>
				<choose>
		        	<when test="b_buy_event != null and b_buy_event != '' ">
		        	
		        		#{b_buy_event},
					</when>
					<otherwise>
		        		null,
				</otherwise>
				</choose>
				<choose>
		        	<when test="b_buy_time != null and b_buy_time!= '' ">
		        	
		        		#{b_buy_time},
					</when>
					<otherwise>
		        		null,
				</otherwise>
				</choose>
				<choose>
		        	<when test="b_buy_day != null and b_buy_day!= '' ">
		        	
		       			 #{b_buy_day},
					</when>
					<otherwise>
		        		null,
				</otherwise>
				</choose>
	<![CDATA[
		        sysdate
		        )		
	]]>
		
	</insert>
	
	<select id="selectListBBuy" resultType="BBuyVo">
		<![CDATA[
			select b.b_buy_no,
			       b.profile_no,
			       b.user_no,
			       p.nickname,
			       p.career,
			       b.b_buy_price,
			       b.b_buy_player_state,
			       b.b_buy_address,
       			   b.b_buy_event,
       			   b.b_buy_time,
       			   b.b_buy_day,
			       k.booking_no ,
			       k.booking_date,
			       k.booking_start,
			       k.booking_end,
			       k.gym_name,
			       k.gym_address,
			       k.gym_event,
			       k.gym_img_savename
			from bbuy b , (select p.profile_no,
			                      p.user_no,
			                      u.user_no,
			                      p.career,
			                      u.nickname
			               from profile p,users u
			               where p.user_no = u.user_no)p,(select b.booking_no,
			                                                     b.booking_start,
			                                                     b.booking_end,
			                                                     b.booking_date,
			                                                     g.gym_name,
			                                                     g.gym_address,
			                                                     g.gym_event,
			                                                     i.gym_img_savename,
			                                                     i.gym_img_type
			                                              from booking b , gym g ,gymImg i
			                                              where b.gym_no = g.gym_no
			                                              and g.gym_no = i.gym_no
			                                              and i.gym_img_type = 'main')k
			where b.profile_no = p.profile_no(+)
			and b.booking_no = k.booking_no(+)
			and b.b_buy_player_state = '시합등록자'
			order by b_buy_no desc
		
		]]>	

	</select>
	<select id="selectOneBBuy" parameterType="BBuyVo" resultType="BBuyVo">
		<![CDATA[
			select  b.b_buy_no,
			        b.user_no,
			        b.booking_no,
			        b.profile_no,
			        b.booking_no,
			        b.b_buy_player_state,
			        b.b_buy_address,
			        b.b_buy_event,
			        b.b_buy_time,
			        b.b_buy_day,
			        u.nickname,
			        u.user_photo,
			        p.height,
			        p.weight,
			        p.career,
			        p.major,
			        p.word
			from bbuy b , users u , profile p 
			where b.user_no =u.user_no
			and b.profile_no = p.profile_no
			and b_buy_player_state = '시합등록자'
			and b_buy_no = #{b_buy_no}
			
		]]>
	
	</select>
	<select id="selectOneMatchScore" parameterType="int" resultType="BBuyVo">
		<![CDATA[
			select  sum(score) as sumScore,
			        sum(win) as sumWin
			from matchscore
			where user_no = #{user_no}
		]]>	
	</select>
	<select id="selectListBBuy2" parameterType="int" resultType="BBuyVo">
	<![CDATA[
	
	
			select b.b_buy_no,
			       b.booking_no,
			       b.profile_no,
			       b.user_no,
			       b.b_buy_player_state,
			       p.word,
			       p.career,
			       p.height,
			       p.weight,
			       p.major,
			       u.nickname,
			       u.user_photo
			from bbuy b, profile p , users u
			where b.profile_no = p.profile_no
			and b.user_no = u.user_no
			and b.b_buy_player_state = '신청자'
			and b.booking_no = #{booking_no}
			order by b.b_buy_no desc
	]]>

	
	</select>
	<select id="selectOnebbuy2" parameterType="BBuyVo" resultType="BBuyVo">
	
		<![CDATA[
			select  b.b_buy_no,
			        b.user_no,
			        b.booking_no,
			        b.profile_no,
			        b.booking_no,
			        b.b_buy_player_state,
			        b.b_buy_address,
			        b.b_buy_event,
			        b.b_buy_time,
			        b.b_buy_day,
			        u.nickname,
			        u.user_photo,
			        p.height,
			        p.weight,
			        p.career,
			        p.major,
			        p.word,
			        m.scorecount
			from bbuy b , users u , profile p , (select count(*) as scorecount
			                                     from matchscore
			                                     where user_no =#{user_no})m
			where b.user_no =u.user_no
			and b.profile_no = p.profile_no
			and b_buy_player_state = '신청자'
			and b_buy_no = #{b_buy_no}
		
		
		]]>
	
	</select>
	
</mapper>